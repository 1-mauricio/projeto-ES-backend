===TABLES===

-- USER KLOTE
user_id, [email] , password!, name, cpf, telefone, first_login, is_admin , admin_id, created_at, update_at

CREATE TABLE user_klote (
    USER_ID INT UNIQUE,
    EMAIL VARCHAR(150) NOT NULL,
    CPF VARCHAR(11) NOT NULL,
    NAME VARCHAR(150) NOT NULL,
    PASSWORD VARCHAR(150) NOT NULL,
    PHONE VARCHAR(11) NOT NULL UNIQUE,
    FIRST_LOGIN BOOLEAN NOT NULL DEFAULT TRUE,
    IS_ADMIN BOOLEAN NOT NULL DEFAULT FALSE,
    CREATED_AT TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    UPDATED_AT TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- ALLOTMENT


CREATE TABLE ALLOTMENT(
    ID INT UNIQUE,
    NAME VARCHAR(150) NOT NULL,
    CEP VARCHAR(8) NOT NULL,
    ADDRESS VARCHAR(150) NOT NULL,
    IMG_URL VARCHAR(150),
    CONSTRAINT PK_ALLOTMENT PRIMARY KEY (ID),
    CREATED_AT TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    UPDATED_AT TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);


-- ALLOTMENT ACCESS


CREATE TABLE ALLOTMENT_ACCESS(
USER_ID INT NOT NULL,
ALLOTMENT_ID INT NOT NULL,
CONSTRAINT PK_USER_ALLOTMENT_ID PRIMARY KEY (USER_ID, ALLOTMENT_ID)
);


-- LOT


CREATE TABLE LOT(
ALLOTMENT_ID INT NOT NULL,
NUMBER INT NOT NULL,
BLOCK VARCHAR(20) NOT NULL,
VALUE NUMERIC(12,2) NOT NULL,
IS_AVAILABLE BOOLEAN NOT NULL DEFAULT TRUE,
CREATED_AT TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
UPDATED_AT TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
CONSTRAINT PK_ALLOTMENT_ID_NUMBER PRIMARY KEY (ALLOTMENT_ID, NUMBER),
CONSTRAINT FK_ALLOTMENT_ID FOREIGN KEY(ALLOTMENT_ID) REFERENCES ALLOTMENT(ID)
);


-- LOT HISTORY


CREATE TABLE LOT_HISTORY(
ID INT UNIQUE NOT NULL,
ALLOTMENT_ID INT NOT NULL,
DESCRIPTION VARCHAR(240) NOT NULL,
NUMBER INT NOT NULL,
CREATED_AT TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
UPDATED_AT TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
CONSTRAINT PK_LOT_HISTORY PRIMARY KEY (ID),
CONSTRAINT FK_ALLOTMENT_ID_NUMBER FOREIGN KEY(ALLOTMENT_ID, NUMBER) REFERENCES LOT(ALLOTMENT_ID, NUMBER)
);


-- CUSTOMER


CREATE TABLE CUSTOMER (
    ID INT NOT NULL,
    ADMIN_ID INT NOT NULL,
    NAME VARCHAR(100) NOT NULL,
    EMAIL VARCHAR(100) NOT NULL,
    ADDRESS VARCHAR(150) NOT NULL,
    IS_ACTIVE BOOLEAN NOT NULL DEFAULT TRUE,
    PHONE1 VARCHAR(20) NOT NULL,
    PHONE2 VARCHAR(20),
    CPF VARCHAR(11), 
    CNPJ VARCHAR(14),
    CORPORATE_NAME VARCHAR(100),
    CREATED_AT TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    UPDATED_AT TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT CUSTOMER_PK PRIMARY KEY (ID),
    CONSTRAINT CUSTOMER_ADMIN_FK FOREIGN KEY (ADMIN_ID) REFERENCES USER_KLOTE(USER_ID)
)

-- PURCHASE


CREATE TABLE PURCHASE (
    ALLOTMENT_ID INT NOT NULL,
    LOT_NUMBER INT NOT NULL,
    CUSTOMER_ID INT NOT NULL,
    DATE_PURCHASE TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT PURCHASE_PK PRIMARY KEY (ALLOTMENT_ID, LOT_NUMBER),
    CONSTRAINT PURCHASE_LOT_FK FOREIGN KEY (ALLOTMENT_ID, LOT_NUMBER) REFERENCES LOT(ALLOTMENT_ID, NUMBER)
)

-- INSTALLMENT

CREATE TABLE INSTALLMENT (
    COD INT NOT NULL,
    VALUE NUMERIC(12,2) NOT NULL,
    DATE TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    IS_PAID BOOLEAN NOT NULL DEFAULT FALSE,
    INSTALLMENT_NUMBER INT NOT NULL,
    ALLOTMENT_ID INT NOT NULL,
    LOT_NUMBER INT NOT NULL,

    CONSTRAINT INSTALLMENT_PK PRIMARY KEY (COD),
    CONSTRAINT INSTALLMENT_ALLOTMENT_FK FOREIGN KEY (ALLOTMENT_ID, LOT_NUMBER) REFERENCES LOT(ALLOTMENT_ID, NUMBER)
)


===SEQUENCES===

-- ALLOTMENT SEQUENCE
CREATE SEQUENCE allotment_id_seq
INCREMENT 1
START 100001;

-- LOT SEQUENCE
CREATE SEQUENCE lot_number_seq
INCREMENT 1
START 1;

-- LOT HISTORY SEQUENCE
CREATE SEQUENCE lot_history_id_seq
INCREMENT 1
START 1;

-- CUSTOMER SEQUENCE
CREATE SEQUENCE customer_id_seq
INCREMENT 1
START 100001;

-- INSTALLMENT SEQUENCE
CREATE SEQUENCE installment_cod_seq
INCREMENT 1
START 1;
